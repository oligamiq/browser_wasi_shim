<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<p id="note">
  ####
</p>

<script type="module">
  import { WASI, File, OpenFile, ConsoleStdout, PreopenDirectory, WASIFarm } from "../../dist/index.js";

  (async () => {
    let args = ["echo_and_rewrite", "hello.txt", "world", "new_world"];
    let env = [];
    let fds = [
      new OpenFile(new File([])), // stdin
      ConsoleStdout.lineBuffered(msg => console.log(`[WASI stdout] ${msg}`)),
      ConsoleStdout.lineBuffered(msg => console.warn(`[WASI stderr] ${msg}`)),
      new PreopenDirectory(".", [
        ["hello.txt", new File(new TextEncoder().encode("Hello, world!"))],
      ]),
    ]
    let wasi_farm = new WASIFarm(
      fds,
      { debug: true },
    );
    console.log("WASI farm created");
    let wasi_ref = await wasi_farm.get_ref();
    if (window.Worker) {
      const myWorker = new Worker("./worker.js", { type: "module" });

      myWorker.postMessage({ wasi_ref });
    } else {
      console.error("Web Workers are not supported in this environment.");
    }
  })();
</script>
</body>
</html>
