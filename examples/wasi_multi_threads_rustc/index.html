<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<div id="terminal"></div>

<!-- <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css" rel="stylesheet"> -->

<link rel="stylesheet" href="../node_modules/xterm/css/xterm.css" />
<script src="../node_modules/xterm/lib/xterm.js"></script>
<script src="../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
<script src="../node_modules/@oligami/shared-object/dist/index.js"></script>

<script type="module">
  import { Fd, File, OpenFile, ConsoleStdout, PreopenDirectory, WASIFarm, WASIFarmAnimal } from "../../dist/index.js";

  var term = new Terminal({
    convertEol: true,
  });
  term.open(document.getElementById('terminal'));

  var fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  fitAddon.fit();

  // term.onData(data => {
  //   term.write(data);
  // });

  const shared = new SharedObject.SharedObject(
    {
      writeln(data) {
        term.writeln(data);
      },
      writeUtf8(data) {
        term.writeUtf8(data);
      },
    },
    "term"
  );

  class XtermStdio extends Fd {
    /*:: term: Terminal*/

    constructor(term/*: Terminal*/) {
      super();
      this.term = term;
    }
    fd_read() {
      // read 0
      return { ret: 0, data: new Uint8Array(0) };
    }
    fd_write(data/*: Uint8Array*/)/*: {ret: number, nwritten: number}*/ {
      let nwritten = 0;
      this.term.writeUtf8(data);
      return { ret: 0, nwritten: data.byteLength };
    }
    fd_prestat_get() {
      // wasi.ERRNO_BADF 8
      return { ret: 8, prestat: null };
    }
    fd_fdstat_get() {
      // wasi.ERRNO_BADF 8
      return { ret: 8, fdstat: null };
    }
    fd_seek() {
      // wasi.ERRNO_BADF 8
      return { ret: 8, offset: 0n };
    }
    fd_filestat_get() {
      // wasi.ERRNO_BADF 8
      return { ret: 8, filestat: null };
    }
    fd_close() {
      // wasi.ERRNO_BADF 8
      return { ret: 8 };
    }
  }

  const farm = new WASIFarm(
    // EOF
    new XtermStdio(term),
    new XtermStdio(term),
    new XtermStdio(term),
    [],
    // { debug: true },
  );

  const worker = new Worker("./worker.js", { type: "module" });

  worker.postMessage({
    wasi_ref: farm.get_ref(),
  });

  // sleep 10000ms
  await new Promise((resolve) => setTimeout(resolve, 10000));
</script>
</body>
</html>
